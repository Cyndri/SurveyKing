(self.webpackChunksurvey_king=self.webpackChunksurvey_king||[]).push([[6637],{91119:function(Oe,z,s){"use strict";s.r(z),s.d(z,{MobileOrPC:function(){return $},default:function(){return x}});var G=s(39428),j=s(3182),Se=s(71194),Z=s(50146),m=s(11849),oe=s(68068),X=s(9761),b=s(1615),e=s(67294),B=s(5977),ue=s(92725),V=s(12997),me=s(49111),W=s(19650),a=s(57663),t=s(71577),d=s(94657),n=s(3980),o=s(27400),y=s(73727),v=s(49914),u=s(96389),r=s(85893),Y=(0,X.Pi)(function(){var E,f,w=(0,v.H)(),K=(0,o.a)(),F=w.success,R=(E=w.setting)===null||E===void 0?void 0:E.submittedSetting,re=(f=w.setting)===null||f===void 0?void 0:f.answerSetting.loginRequired,C=w.survey,Q=w.id,te=(0,e.useMemo)(function(){return C?(0,u.R6)(C):{}},[C]),k=R||{},T=k.contentHtml,I=k.redirectUrl,i=k.answerAnalysis,se=k.rankVisible,ne=k.transcriptVisible,le=w.answerId,fe=w.answerQrCodeUrl,H=w.answerView,g=w.values;(0,e.useEffect)(function(){if(I&&g){if(!I.includes("(")){window.location.href=I;return}var D=(0,u.vW)(I,function(O){var ie=(0,u.Op)(O),ae=(0,d.Z)(ie,2),de=ae[0],ge=ae[1],ve=g[de];return(0,u.d0)(te,ve,O)});D.success&&(window.location.href=D.result)}},[I,g]),(0,e.useEffect)(function(){F&&C&&g&&H&&(0,u.MA)(C,T,g,H.examScore)},[T,F,C,g,H]);var J=function(){var O="";return i&&se?O="\u67E5\u770B\u6392\u540D\u53CA\u89E3\u6790":se?O="\u67E5\u770B\u8003\u8BD5\u6392\u540D":(i||ne)&&(O="\u67E5\u770B\u7B54\u6848\u89E3\u6790"),O?(0,r.jsx)("div",{children:(0,r.jsx)(t.Z,{onClick:function(){return window.open("/s/".concat(Q,"/exam-result/").concat(le))},children:O})}):(0,r.jsx)(r.Fragment,{})};return F?(0,r.jsx)("div",{className:"survey-end animated",children:(0,r.jsx)("div",{className:"survey-end-content",children:(0,r.jsx)("h3",{className:"survey-end-title ",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{id:"result-message"}),J(),(0,r.jsx)("div",{children:re&&(0,r.jsxs)(W.Z,{children:[(0,r.jsx)(y.rU,{to:"/",children:(0,r.jsx)(t.Z,{type:"link",onClick:function(){},children:"\u8FD4\u56DE\u9996\u9875"})}),(0,r.jsx)(t.Z,{type:"link",onClick:function(){K.logout(),(0,n.on)()},children:"\u9000\u51FA\u5173\u95ED"})]})})]})})})}):(0,r.jsx)(r.Fragment,{})}),q=Y;function L(E){return e.createElement("svg",Object.assign({width:"1em",height:"1em",viewBox:"0 0 48 48",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink"},E,{style:Object.assign({verticalAlign:"-0.125em"},E.style),className:["antd-mobile-icon",E.className].filter(Boolean).join(" ")}),e.createElement("g",{id:"ExclamationCircleFill-ExclamationCircleFill",stroke:"none",strokeWidth:1,fill:"none",fillRule:"evenodd"},e.createElement("g",null,e.createElement("rect",{id:"ExclamationCircleFill-\u77E9\u5F62",fill:"#D76060",opacity:0,x:0,y:0,width:48,height:48}),e.createElement("path",{d:"M24,2 C36.1502645,2 46,11.8497355 46,24 C46,36.1502645 36.1502645,46 24,46 C11.8497355,46 2,36.1502645 2,24 C2,11.8497355 11.8497355,2 24,2 Z M25.1,31 L22.9,31 C22.6790861,31 22.5,31.1790861 22.5,31.4 L22.5,31.4 L22.5,33.6 C22.5,33.8209139 22.6790861,34 22.9,34 L22.9,34 L25.1,34 C25.3209139,34 25.5,33.8209139 25.5,33.6 L25.5,33.6 L25.5,31.4 C25.5,31.1790861 25.3209139,31 25.1,31 L25.1,31 Z M25.1,14 L22.9,14 C22.6790861,14 22.5,14.1790861 22.5,14.4 L22.5,14.4 L22.5,27.6 C22.5,27.8209139 22.6790861,28 22.9,28 L22.9,28 L25.1,28 C25.3209139,28 25.5,27.8209139 25.5,27.6 L25.5,27.6 L25.5,14.4 C25.5,14.1790861 25.3209139,14 25.1,14 L25.1,14 Z",id:"ExclamationCircleFill-\u5F62\u72B6\u7ED3\u5408",fill:"currentColor",fillRule:"nonzero"}))))}var ee=L,P=s(78210),N=s(32235),$=(0,X.Pi)(function(){var E,f,w,K,F=(0,B.UO)(),R=F.id,re=F.answerId,C=(0,B.TH)(),Q=C.query.preview==="1",te=C.query.pattern,k=C.query.openid,T=(0,e.useMemo)(function(){return(0,u.SB)()},[]),I=(0,e.useRef)(null),i=(0,e.useMemo)(function(){return new N.b({surveyRef:I,id:R,answerId:re})},[I,R,re]),se=i.saving,ne=i.loading,le=(E=i.setting)===null||E===void 0?void 0:E.answerSetting,fe=i.loginRequired,H=i.verifying,g=le||{},J=g.autoSave,D=g.progressBar,O=g.initialValues,ie=g.questionNumber,ae=g.wechatOnly,de=g.onePageOneQuestion,ge=g.answerSheetVisible,ve=g.triggerType,_e=g.copyEnabled,pe=((f=i.setting)===null||f===void 0?void 0:f.examSetting)||{},be=pe.exerciseMode,M=pe.maxSwitchScreenTimes,xe=!!((w=i.setting)!==null&&w!==void 0&&(K=w.examSetting)!==null&&K!==void 0&&K.randomSurveyWrong),Te=i.errorMessage,ce=i.savedAnswer,ye=i.confirmTempAnswerType,De=i.statistics,U=i.survey,we=i.answerId,je=i.mode,Ee=i.success,Ce=(0,u.XO)(U,C);(0,e.useEffect)(function(){U&&(0,u.iq)(U,"statEnabled","quota")&&i.loadStatistics()},[U,i]);var Le=(0,e.useCallback)(function(S,h){D&&i.changeProgress(h),J&&S&&i.tempSave(S)},[D]),ke=function(){return(0,r.jsx)(V.BW,{})};(0,e.useEffect)(function(){if(M!==void 0){var S=!1;window.onfocus=function(){S=!0},window.onblur=function(){if(!!S){var h="ebt-".concat(R),c=parseInt(localStorage.getItem(h)||"0")+1;if(c>M){var l,A=(l=I.current)===null||l===void 0?void 0:l.getValues();i.saveData((0,m.Z)((0,m.Z)({},A),{},{openid:k}),{forceSubmit:!0}).then(function(p){p!=null&&p.success&&localStorage.removeItem(h),!(p!=null&&p.success)&&p!==null&&p!==void 0&&p.message&&(T?b.u_.alert({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(P.Z,{html:p.message})}):Z.Z.error({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(P.Z,{html:p.message}),okText:"\u77E5\u9053\u4E86"}))});return}console.log("lose focus ".concat(c)),T?b.u_.alert({header:(0,r.jsx)(ee,{style:{fontSize:64,color:"var(--adm-color-warning)"}}),title:"\u6CE8\u610F",content:(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{children:["\u6700\u591A\u53EF\u4EE5\u5207\u5C4F ",M," \u6B21\uFF0C\u68C0\u6D4B\u5230\u4F60\u5DF2\u5207\u6362\u4E86 ",c," \u6B21\uFF0C\u8D85\u8FC7",M," \u6B21\u95EE\u5377\u5C06\u5F3A\u5236\u63D0\u4EA4\u3002"]})})}):Z.Z.warning({title:"\u63D0\u793A",content:"\u6700\u591A\u53EF\u4EE5\u5207\u5C4F ".concat(M," \u6B21\uFF0C\u68C0\u6D4B\u5230\u4F60\u5DF2\u5207\u6362\u4E86 ").concat(c," \u6B21\uFF0C\u8D85\u8FC7 ").concat(M," \u6B21\u95EE\u5377\u5C06\u5F3A\u5236\u63D0\u4EA4\u3002"),okText:"\u6211\u77E5\u9053\u4E86"}),localStorage.setItem(h,"".concat(c))}}}},[M]);var Ie=function(h){var c,l;return(0,r.jsxs)("div",{className:"render-failure ".concat(T?"mobile":"phone"),children:[((c=i.project)===null||c===void 0?void 0:c.name)&&(0,r.jsx)("div",{className:"title",children:(l=i.project)===null||l===void 0?void 0:l.name}),(0,r.jsxs)("div",{className:"content",children:[(0,r.jsx)("div",{children:(0,r.jsx)(V.AT,{})}),(0,r.jsx)("h2",{children:Te||h}),(0,r.jsx)("div",{children:"\u611F\u8C22\u5173\u6CE8\uFF01"})]})]})},Ae=function(){if(Ee)return(0,r.jsx)(r.Fragment,{});if(ne)return(0,r.jsx)(ue.Z,{});if(i.errorCode!==200)return Ie();if(ae&&!(0,u.CL)())return Ie("\u53EA\u80FD\u5728\u5FAE\u4FE1\u4E2D\u6253\u5F00");if(fe)return(0,r.jsx)("div",{children:ke()});if(U&&!Ee&&!H)return ye===1&&J&&je==="survey"&&!we?(0,r.jsx)(V.oq,{}):(0,r.jsx)("div",{style:{userSelect:_e===!1?"none":"unset"},children:(0,r.jsx)(oe.Z,{ref:I,mode:je,loading:se||ne,progressBar:D,questionNumber:ie,theme:T?"antdMobile":"antd",schema:U,onChange:Le,onePageOneQuestion:de,answerSheetVisible:ge,exerciseMode:be,wrongMode:xe,pattern:te,triggerType:ve,onInit:function(c){i.tempSave(c.values)},onDictSearch:function(){var h=(0,j.Z)((0,G.Z)().mark(function c(l){var A;return(0,G.Z)().wrap(function(_){for(;;)switch(_.prev=_.next){case 0:return _.next=2,n.hi.loadDict(l);case 2:if(A=_.sent,!A.success){_.next=5;break}return _.abrupt("return",A.data);case 5:return _.abrupt("return",[]);case 6:case"end":return _.stop()}},c)}));return function(c){return h.apply(this,arguments)}}(),initialValues:ye===3?Ce:(0,m.Z)((0,m.Z)((0,m.Z)((0,m.Z)({},O),J?ce==null?void 0:ce.answer:{}),Ce),i.values),statistics:De,onUpload:function(c,l){return i.upload(c,l)},footerVisible:!(Q||te==="readPretty"),headerVisible:!Q,isPreview:Q,onLink:function(c){n.hi.loadLinkResult((0,m.Z)((0,m.Z)({},c),{},{projectId:R})).then(function(l){if(l.success&&l.data.answer){var A=l.data.answer;Object.keys(A).forEach(function(p){var _=A[p];if(c.questionId!==p){var he;(he=I.current)===null||he===void 0||he.setValue(p,_)}})}})},onSubmit:function(c){i.saveData((0,m.Z)((0,m.Z)({},c),{},{openid:k}),{answerId:we}).then(function(l){!(l!=null&&l.success)&&l!==null&&l!==void 0&&l.message&&(T?b.u_.alert({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(P.Z,{html:l.message})}):Z.Z.error({title:"\u4FDD\u5B58\u5931\u8D25",content:(0,r.jsx)(P.Z,{html:l.message}),okText:"\u77E5\u9053\u4E86"}))})}})})},Pe=function(){return(0,r.jsx)(q,{})},Me=function(){var h,c,l=(h=i.survey)===null||h===void 0||(c=h.attribute)===null||c===void 0?void 0:c.backgroundImage;if(l)return{backgroundImage:"url(/api/public/preview/".concat(l,")")}};return(0,r.jsx)(u.ff.Provider,{value:i,children:(0,r.jsxs)("div",{className:"survey ".concat(T?"mobile":"pc"),style:Me(),children:[Ae(),Pe()]})})}),x=$},32235:function(Oe,z,s){"use strict";s.d(z,{b:function(){return me}});var G=s(11849),j=s(39428),Se=s(34792),Z=s(48086),m=s(3182),oe=s(69610),X=s(54941),b=s(3980),e=s(54531),B=s(36855),ue=s(42238),V=s.n(ue),me=function(){function W(a){var t;(0,oe.Z)(this,W),this.id=void 0,this.project=void 0,this.survey=void 0,this.loading=void 0,this.verifying=!1,this.saving=!1,this.isPC=void 0,this.errorCode=void 0,this.errorMessage=void 0,this.progress=0,this.confirmTempAnswerType=0,this.statistics=void 0,this.answerUrl=void 0,this.answerQrCodeUrl=void 0,this.loginRequired=void 0,this.whitelistName=void 0,this.success=void 0,this.answerId=void 0,this.repoId=void 0,this.examExerciseType=void 0,this.answerView=void 0,this.values=void 0,this.initialQuestionScore=void 0,this.openId=void 0,this.token=void 0,this.surveyRef=void 0,this.id=a.id,this.answerId=a.answerId,this.surveyRef=a.surveyRef,this.repoId=a.repoId,this.examExerciseType=a.examExerciseType;var d=B.parse(window.location.search);d&&(this.openId=d.openId,this.token=d["sk-token"]),this.makeObservable(),this.loadProject(),this.confirmTempAnswerType=(t=this.savedAnswer)!==null&&t!==void 0&&t.progress?1:0}return(0,X.Z)(W,[{key:"makeObservable",value:function(){(0,e.Ou)(this,{id:e.LO.ref,answerId:e.LO.ref,survey:e.LO.ref,loading:e.LO.ref,saving:e.LO.ref,verifying:e.LO.ref,project:e.LO.ref,errorCode:e.LO.ref,errorMessage:e.LO.ref,progress:e.LO.ref,confirmTempAnswerType:e.LO.ref,statistics:e.LO.ref,answerUrl:e.LO.ref,answerQrCodeUrl:e.LO.ref,success:e.LO.ref,answerView:e.LO.ref,values:e.LO.ref,loginRequired:e.LO.ref,whitelistName:e.LO.ref,openId:e.LO.ref,token:e.LO.ref,passwordRequired:e.LO.computed,mode:e.LO.computed,tempSaveId:e.LO.computed,status:e.LO.computed,setting:e.LO.computed,tempSave:e.aD,saveData:e.aD,loadProject:e.aD,changeProgress:e.aD,validate:e.aD})}},{key:"setting",get:function(){var t;return(t=this.project)===null||t===void 0?void 0:t.setting}},{key:"status",get:function(){var t;return(t=this.project)===null||t===void 0?void 0:t.status}},{key:"passwordRequired",get:function(){var t;return(t=this.project)===null||t===void 0?void 0:t.passwordRequired}},{key:"mode",get:function(){var t;return(t=this.project)===null||t===void 0?void 0:t.mode}},{key:"tempSaveId",get:function(){return"savedAnswer-"+this.id}},{key:"savedAnswer",get:function(){var t=localStorage.getItem(this.tempSaveId);return t&&JSON.parse(t)}},{key:"startTime",get:function(){var t,d,n;return((t=this.savedAnswer)===null||t===void 0||(d=t.metaInfo)===null||d===void 0||(n=d.answerInfo)===null||n===void 0?void 0:n.startTime)||new Date().getTime()}},{key:"tempSave",value:function(t){var d=localStorage.getItem(this.tempSaveId),n;d?(n=JSON.parse(d),n.answer=t,n.progress=this.progress):n={answer:t,metaInfo:{answerInfo:{startTime:new Date().getTime()}},progress:this.progress},localStorage.setItem(this.tempSaveId,JSON.stringify(n))}},{key:"saveData",value:function(){var a=(0,m.Z)((0,j.Z)().mark(function d(n,o){var y,v,u=this,r,Y,q,L,ee,P,N,$,x;return(0,j.Z)().wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(r=o||{},Y=r.answerId,q=r.forceSubmit,this.saving=!0,L=new(V())().getResult(),ee={answer:n,projectId:this.id,metaInfo:{answerInfo:{startTime:this.startTime,endTime:new Date().getTime()},clientInfo:{browser:L.browser.name||"",browserVersion:L.browser.version||"",deviceType:L.device.type||"",platform:L.os.name||"",platformVersion:L.os.version||""}},id:Y||this.answerId,whitelistName:this.whitelistName},P=this.startTime,N=((y=this.project)===null||y===void 0||(v=y.setting.examSetting)===null||v===void 0?void 0:v.minSubmitMinutes)||0,$=P+N*60*1e3,!(N>0&&new Date().getTime()<$&&q!==!0)){f.next=11;break}return Z.default.error("\u672A\u5230\u4EA4\u5377\u65F6\u95F4"),this.saving=!1,f.abrupt("return");case 11:return f.next=13,b.hi.post(this.getUrlWithToken("/api/public/saveAnswer"),ee);case 13:return x=f.sent,(0,e.aD)(function(){x.success&&(x.data.answerId?u.answerId=x.data.answerId:x.data.examScore!==void 0,u.answerView=x.data,u.values=n,u.success=!0,localStorage.removeItem(u.tempSaveId)),u.saving=!1}),f.abrupt("return",x);case 16:case"end":return f.stop()}},d,this)}));function t(d,n){return a.apply(this,arguments)}return t}()},{key:"loadStatistics",value:function(){var a=(0,m.Z)((0,j.Z)().mark(function d(){var n=this,o;return(0,j.Z)().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:if(!this.loading){v.next=2;break}return v.abrupt("return");case 2:return this.loading=!0,v.next=5,b.hi.post(this.getUrlWithToken("/api/public/statistics"),{id:this.id});case 5:o=v.sent,(0,e.aD)(function(){o.success&&(n.statistics=o.data),n.loading=!1});case 7:case"end":return v.stop()}},d,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"loadProject",value:function(){var a=(0,m.Z)((0,j.Z)().mark(function d(){var n=this,o;return(0,j.Z)().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return this.loading=!0,v.next=3,b.hi.post(this.getUrlWithToken("/api/public/loadProject"),{id:this.id,answerId:this.answerId,repoId:this.repoId,examExerciseType:this.examExerciseType});case 3:o=v.sent,(0,e.aD)(function(){if(o.success){var u;n.project=o.data,n.loginRequired=o.data.loginRequired,n.initialQuestionScore=(u=o.data.examInfo)===null||u===void 0?void 0:u.questionScore,n.survey=o.data.survey,n.values=o.data.answer,o.data.answerId&&(n.answerId=o.data.answerId)}else n.errorMessage=o.message;n.errorCode=o.code,n.loading=!1});case 5:case"end":return v.stop()}},d,this)}));function t(){return a.apply(this,arguments)}return t}()},{key:"validate",value:function(){var a=(0,m.Z)((0,j.Z)().mark(function d(n){var o=this,y;return(0,j.Z)().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return this.verifying=!0,u.next=3,b.hi.post(this.getUrlWithToken("/api/public/validateProject"),{id:this.id,answer:n,answerId:this.answerId});case 3:y=u.sent,(0,e.aD)(function(){if(y.success){var r;o.project=y.data,o.loginRequired=!1,o.survey=y.data.survey,o.whitelistName=(r=n.whitelistName)===null||r===void 0?void 0:r.whitelistName}else Z.default.error(y.message);o.verifying=!1});case 5:case"end":return u.stop()}},d,this)}));function t(d){return a.apply(this,arguments)}return t}()},{key:"upload",value:function(){var a=(0,m.Z)((0,j.Z)().mark(function d(n,o){return(0,j.Z)().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:return v.abrupt("return",b.hi.upload("/api/public/upload",(0,G.Z)({fileType:4,basePath:this.id},n),o));case 1:case"end":return v.stop()}},d,this)}));function t(d,n){return a.apply(this,arguments)}return t}()},{key:"changeProgress",value:function(t){this.progress=t}},{key:"getUrlWithToken",value:function(t){return B.stringifyUrl({url:t,query:{"sk-token":this.token}})}}]),W}()}}]);
